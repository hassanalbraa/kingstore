
/**
 * @fileoverview Firestore Security Rules for KING STORE application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and user-specific data.
 * Administrative privileges are managed through a separate collection, ensuring clear separation of concerns.
 * Game offers are publicly accessible, but their management is restricted.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only by the user themselves.
 * - /gameOffers/{gameOfferId}: Stores publicly accessible game offers.
 * - /users/{userId}/userGameOffers/{userGameOfferId}: Stores the relationships between users and purchased game offers, accessible only by the user.
 * - /roles_admin/{userId}: Indicates users with admin privileges. Document existence grants admin rights.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Admin status is determined by document existence in `/roles_admin/{userId}`.
 * - Ambiguous relationships default to strict owner-only access.
 *
 * Denormalization for Authorization:
 * - Admin status is denormalized into the `roles_admin` collection to avoid `get()` calls in security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      // Allow user to update their own balance, but with a transaction to ensure validity
      allow update: if (isOwner(userId) && request.resource.data.balance <= resource.data.balance) || isAdmin();
      allow delete: if isAdmin();
    }

    match /gameOffers/{gameOfferId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // Combined rule for user and admin access to userGameOffers
    match /{path=**}/userGameOffers/{offerId} {
      // Read: Admins can read anything. Users can only read their own documents.
      // Note: For a 'list' operation on a collection, 'resource' is not available. 
      // This is a known limitation. The query from the client MUST include a `where('userId', '==', request.auth.uid)` clause.
      // The rules below are primarily for 'get' on a single document. List operations are implicitly secured by the client-side query.
      allow get: if isAdmin() || isOwner(resource.data.userId);
      
      // The client-side queries are already structured to only fetch relevant data:
      // - User fetches from /users/{their-own-id}/userGameOffers
      // - Admin fetches a collectionGroup query for pending orders.
      // These rules provide an additional layer of security.
      allow list: if isAdmin() || (request.auth != null && request.path[2] == request.auth.uid);
      
      // Create: A user can create an offer for themselves.
      allow create: if isOwner(request.resource.data.userId);

      // Update: Only admins can update the status of an offer (e.g., to 'completed').
      allow update: if isAdmin();

      // Delete: A user can delete their own offer document.
      allow delete: if isOwner(resource.data.userId);
    }


     match /roles_admin/{userId} {
       allow get: if true;
       allow list: if isAdmin();
       allow create: if isOwner(userId);
       allow delete: if isAdmin();
       allow update: if false;
     }
  }
}
