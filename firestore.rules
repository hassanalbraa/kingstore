
/**
 * @fileoverview Firestore Security Rules for KING STORE application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and user-specific data.
 * Administrative privileges are managed through a separate collection, ensuring clear separation of concerns.
 * Game offers are publicly accessible, but their management is restricted.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only by the user themselves.
 * - /gameOffers/{gameOfferId}: Stores publicly accessible game offers.
 * - /users/{userId}/userGameOffers/{userGameOfferId}: Stores the relationships between users and purchased game offers, accessible only by the user.
 * - /roles_admin/{userId}: Indicates users with admin privileges. Document existence grants admin rights.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Admin status is determined by document existence in `/roles_admin/{userId}`.
 * - Ambiguous relationships default to strict owner-only access.
 *
 * Denormalization for Authorization:
 * - Admin status is denormalized into the `roles_admin` collection to avoid `get()` calls in security rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      // Allow any authenticated user to list users, the client-side code will only do this for admins.
      allow list: if request.auth != null;
      allow create: if isOwner(userId);
      // Allow user to update their own balance, but with a transaction to ensure validity
      allow update: if (isOwner(userId) && request.resource.data.balance <= resource.data.balance) || isAdmin();
      allow delete: if isAdmin();
    }

    match /gameOffers/{gameOfferId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // --- Start: New Simplified Rules for UserGameOffers ---

    // Rule specifically for a user accessing their OWN offers.
    // This is the primary rule for non-admin users.
    match /users/{userId}/userGameOffers/{userGameOfferId} {
      allow get, list, create, delete: if isOwner(userId);
      // A regular user can never update the status of their own order.
      allow update: if false;
    }
    
    // Rule specifically for ADMINS using a collection group query.
    // This allows admins to see and update all orders across all users.
    match /{path=**}/userGameOffers/{userGameOfferId} {
       allow get, list, update: if isAdmin();
       // Admins should not create or delete orders through this general path to avoid errors.
       allow create, delete: if false;
    }

    // --- End: New Simplified Rules for UserGameOffers ---

     match /roles_admin/{userId} {
       allow get: if true;
       allow list: if isAdmin();
       allow create: if isOwner(userId);
       allow delete: if isAdmin();
       allow update: if false;
     }
  }
}
